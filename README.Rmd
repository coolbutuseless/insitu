---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = TRUE
)

library(dplyr)
library(ggplot2)
library(bench)
library(tidyr)
library(patchwork)

library(insitu)
```

# insitu

<!-- badges: start -->
![](https://img.shields.io/badge/cool-useless-green.svg)
![](https://img.shields.io/badge/api-unstable-orange.svg)
[![R-CMD-check](https://github.com/coolbutuseless/insitu/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/coolbutuseless/insitu/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

`insitu` provides some functions for modifying numeric vectors *in-place* i.e. without allocating a new vector.



## Modifying vectors in-place


**Pros** of modifying in-situ

* Often faster as there is reduced memory allocation (and also reduced pressure
  on the garbage collector)
* Often faster as there is no copying from the original vector into a new vector
* By using C to write `{insitu}`, we can override the *copy-on-modify* semantics usually used in R
  (regardless of how many references exist to the given object)

    
## What's in the box

| insitu                                  | description                                                            |
|-----------------------------------------|------------------------------------------------------------------------|
| fmadd, fmsub, fnmadd, fnmsub            | Fused multiply add                                                     |
| ins_fill(x, value)                   | Fill vector with the given value                                       |
| ins_runif(x, lower, upper) | Fill vector with uniform random numbers                                |
| ins_replace(x, pos, values)          | Replace values in x with given values starting from the given position |
| ins_reverse(x)                       | Reverse vector                                                         |
| ins_shuffle(x)                  | Shuffle the elements of a vector                                       |
| ins_sort(x)                          | Sort the elements of a vector                                          |
| ins_copy(x, y) | copy contents of y into x |
| ins_copy_from(x, y, xi, yi, n) | copy 'n' elements from 'y' into 'x' starting at 'xi' and 'yi' |
| `ins_abs()`, `ins_sqrt()`,`ins_floor()`,`ins_ceil()`, `ins_trunc()`, `ins_round()`, `ins_exp()`, `ins_log()`, `ins_cos()`, `ins_sin()`, `ins_tan()`, `ins_not()`, `ins_expm1()`, `ins_log1p()`, `ins_acos()`,`ins_asin()`, `ins_atan()`,`ins_acosh()`,`ins_asinh()`,`ins_atanh()`,`ins_cosh()`, `ins_sinh()`,`ins_tanh()`, `ins_sign()`, `ins_cospi()`, `ins_sinpi()`, `ins_tanpi()`, `ins_cumsum()`, `ins_cumprod()`, `ins_cummax()`, `ins_cummin()`, `ins_log2()`, `ins_log10()` | Standard single argument math operations |
| `ins_add()`, `ins_sub()`, `ins_mul()`, `ins_div()`, `ins_eq()`, `ins_ne()`, `ins_lt()`, `ins_le()`, `ins_gt()`, `ins_ge()`, `ins_and()`, `ins_or()`, `ins_rem()`, `ins_idiv()`, `ins_max()`, `ins_min()`, 
`ins_hypot()` | Standard two-argument math operations | 




#### RNG

`insitu` uses a custom random-number generator called  [lehmer](https://lemire.me/blog/2019/03/19/the-fastest-conventional-random-number-generator-that-can-pass-big-crush/).

This RNG is fast, but it may have slightly different properties compared to R's built-in random 
number generator.

#### ALTREP utils

* `is_altrep(x)` tests whether an object is an ALTREP
* `is_mutable(x)` tests whether an object is mutable by checking its
  reference count
* `get_refcnt(x)` returns the reference count for the object 



## Installation

You can install from [GitHub](https://github.com/coolbutuseless/insitu) with:

``` r
# install.packages('remotes')
remotes::install_github('coolbutuseless/insitu')
```




## Replace

`ins_replace()` is analogous to `replace()` but replaces values in the current 
vector rather than creating a new one.

```{r}
x <- numeric(10)
ins_replace(x, 6, c(1, 2, 3, 4, 5))
x
```



## Fill


`ins_fill()` is analogous to `replace()` but assigns the value into the current 
vector rather than creating a new one.


```{r}
x <- numeric(10)
ins_fill(x, 3)
x
```


## Sort

`ins_sort()` is analogous to `sort()` but sorts values in the current 
vector rather than creating a new one.

```{r}
x <- as.numeric(sample(10))
x
ins_sort(x)
x
```



## Shuffle


`ins_shuffle()` is analogous to `sample()` but shuffles values in the current 
vector rather than creating a new one.

```{r}
set.seed(1)
x <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
ins_shuffle(x)
x
```




## Reverse

`ins_reverse()` is analogous to `rev()` but reverses values in the current 
vector rather than creating a new one.


```{r}
x <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
ins_reverse(x)
x
```







## Fill with random

`ins_runif()` is analogous to `runif()` but generates values in the current 
vector rather than creating a new one.


```{r}
set.seed(1)
x <- numeric(10)
ins_runif(x, 10, 15)
x
```




## Fused multiply add (FMA)

* `fmadd(x, a, b)` in-situ `x * a + b`
* `fmsub(x, a, b)` in-situ `x * a - b`
* `fnmadd(x, a, b)` in-situ `-x * a + b`
* `fnmsub(x, a, b)` in-situ `-x * a - b`


```{r}
x <- as.numeric(1:10)
a <- 2
b <- as.numeric(1:10)
fmadd(x, a, b)
x
```




## Related Software

* [data.table](https://cran.r-project.org/package=data.table) performs a lot of 
  operations in-situ (i.e. "by reference")

